---
import Layout from './Layout.astro';
import { posts } from '../data/posts';
import { siteConfig } from '../config/site';

// Get slug from frontmatter or URL
const frontmatter = Astro.props.frontmatter || Astro.props;
const slug = frontmatter.slug || Astro.url.pathname.split('/').pop();

// Find post data from posts.ts using slug
const currentPost = posts.find(post => post.slug === slug);

// Use data from posts.ts as source of truth, fallback to frontmatter
const title = currentPost?.title || frontmatter.title;
const description = currentPost?.description || currentPost?.excerpt || frontmatter.description;
const date = currentPost?.date || frontmatter.date;
const category = currentPost?.category || frontmatter.category;
const readTime = currentPost?.readTime || frontmatter.readTime;
const image = currentPost?.image || frontmatter.image;

// Format date
const formattedDate = new Date(date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// ISO date for structured data
const isoDate = new Date(date).toISOString();

// Filter out current post and get 3 related posts
const relatedPosts = posts
  .filter(post => post.slug !== slug)
  .slice(0, 3);

// Structured data (JSON-LD) for SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": title,
  "description": description,
  "image": new URL(image, Astro.site).toString(),
  "datePublished": isoDate,
  "dateModified": isoDate,
  "author": {
    "@type": "Organization",
    "name": siteConfig.name,
    "url": siteConfig.url
  },
  "publisher": {
    "@type": "Organization",
    "name": siteConfig.name,
    "logo": {
      "@type": "ImageObject",
      "url": new URL("/logo.png", Astro.site).toString()
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": new URL(Astro.url.pathname, Astro.site).toString()
  },
  "articleSection": category,
  "keywords": [category, "mental health", "burnout", "wellness"]
};

// Get category color classes
const getCategoryClasses = (cat: string) => {
  const categoryMap: Record<string, string> = {
    'Burnout': 'bg-red-100 dark:bg-red-500/10 text-red-600 dark:text-red-400',
    'Mental Health': 'bg-emerald-100 dark:bg-emerald-500/10 text-emerald-600 dark:text-emerald-400',
    'Work-Life Balance': 'bg-blue-100 dark:bg-blue-500/10 text-blue-600 dark:text-blue-400',
    'Work Culture': 'bg-orange-100 dark:bg-orange-500/10 text-orange-600 dark:text-orange-400',
    'Society': 'bg-violet-100 dark:bg-violet-500/10 text-violet-600 dark:text-violet-400',
    'Recovery': 'bg-teal-100 dark:bg-teal-500/10 text-teal-600 dark:text-teal-400',
  };
  
  return categoryMap[cat] || 'bg-gray-100 dark:bg-white/5 text-gray-700 dark:text-gray-300';
};
---

<Layout 
  title={title} 
  description={description}
  image={image}
  article={true}
  publishedTime={isoDate}
  modifiedTime={isoDate}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <article class="py-12 sm:py-16 lg:py-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <header class="mb-12">
        <div class="flex items-center gap-3 mb-6 text-sm">
          <span class={`px-3 py-1 rounded-full font-medium ${getCategoryClasses(category)}`}>
            {category}
          </span>
          <span class="light:text-gray-500 dark:text-gray-400">{formattedDate}</span>
          <span class="light:text-gray-400 dark:text-gray-500">â€¢</span>
          <span class="light:text-gray-500 dark:text-gray-400">{readTime}</span>
        </div>
        
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold light:text-gray-900 dark:text-white mb-6 leading-tight">
          {title}
        </h1>
        
        <p class="text-xl light:text-gray-600 dark:text-gray-300 leading-relaxed">
          {description}
        </p>
      </header>

      <!-- Featured Image -->
      {image && (
        <div class="mb-12 rounded-2xl overflow-hidden">
          <img 
            src={image} 
            alt={title}
            class="w-full h-auto object-cover"
          />
        </div>
      )}

      <!-- Content -->
      <div class="blog-content">
        <slot />
      </div>

      <!-- Related Posts -->
      <div class="mt-16 pt-16 border-t light:border-gray-200 dark:border-white/10">
        <h2 class="text-2xl sm:text-3xl font-bold light:text-gray-900 dark:text-white mb-8">
          Continue Reading
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {relatedPosts.map((post) => (
            <a 
              href={`/blog/${post.slug}`}
              class="group block light:bg-white dark:bg-white/5 rounded-xl overflow-hidden border light:border-gray-200 dark:border-white/10 hover:light:border-primary hover:dark:border-primary transition-all duration-300"
            >
              <div class="aspect-video overflow-hidden">
                <img 
                  src={post.image} 
                  alt={post.title}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                />
              </div>
              
              <div class="p-5">
                <div class="flex items-center gap-2 text-xs mb-3">
                  <span class={`px-2 py-1 rounded-full ${getCategoryClasses(post.category)}`}>
                    {post.category}
                  </span>
                  <span class="light:text-gray-400 dark:text-gray-500">{post.readTime}</span>
                </div>
                
                <h3 class="text-lg font-bold light:text-gray-900 dark:text-white mb-2 group-hover:text-primary transition-colors line-clamp-2">
                  {post.title}
                </h3>
                
                <p class="text-sm light:text-gray-600 dark:text-gray-400 line-clamp-2">
                  {post.excerpt}
                </p>
              </div>
            </a>
          ))}
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-12 pt-8 border-t light:border-gray-200 dark:border-white/10">
        <a 
          href="/blog"
          class="inline-flex items-center gap-2 light:text-gray-600 dark:text-gray-400 hover:light:text-gray-900 hover:dark:text-white transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to all posts
        </a>
      </footer>
    </div>
  </article>
</Layout>
